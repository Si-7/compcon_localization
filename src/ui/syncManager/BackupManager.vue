<template>
  <v-card>
    <v-card-text>
      <v-row>
        <v-col>
          <v-menu top offset-y>
            <template v-slot:activator="{ on }">
              <v-btn block color="accent" v-on="on">
                <v-icon left>mdi-database</v-icon>
                Создать Бэкап
              </v-btn>
            </template>
            <v-card max-width="30vw">
              <v-card-text class="text-center stark--text">
                Этот инструмент сохранит снимок всех локальных пользовательских данных и содержимого LCP, 
                включая данные, помеченные для удаления. Он создает файл .compcon, который можно загрузить 
                из интерфейса «Загрузить резервную копию».
                <v-divider class="my-3" />
                <v-btn block color="accent" @click="dataExport()">Generate Backup</v-btn>
              </v-card-text>
            </v-card>
          </v-menu>
        </v-col>
        <v-col>
          <v-menu v-model="loadBackupDialog" top offset-y :close-on-content-click="false">
            <template v-slot:activator="{ on }">
              <v-btn block color="accent" v-on="on">
                <v-icon left>mdi-database-refresh</v-icon>
                Загрузить Бэкап
              </v-btn>
            </template>
            <v-card max-width="30vw">
              <v-card-text class="text-center stark--text">
                Этот инструмент использует файл .compcon, созданный с помощью параметра «Создать резервную копию». Он заменит все локальные данные.
                <v-divider class="my-3" />
                <v-file-input
                  v-model="fileValue"
                  accept=".compcon"
                  outlined
                  dense
                  hide-details
                  autofocus
                  placeholder="Выберите файл массового экспорта COMP/CON"
                  prepend-icon="mdi-paperclip"
                />
                <v-divider class="my-3" />
                <v-btn
                  v-model="importConfirm"
                  block
                  :color="importConfirm ? 'secondary' : 'accent'"
                  :disabled="!fileValue"
                  @click="importConfirm = true"
                >
                  Подтвердить
                </v-btn>
                <v-btn
                  block
                  small
                  color="secondary"
                  class="my-2"
                  @click="importfile"
                  :disabled="!importConfirm"
                >
                Перезаписать локальные данные
                </v-btn>
              </v-card-text>
            </v-card>
          </v-menu>
        </v-col>
        <v-col>
          <v-menu v-model="deleteLocal" top offset-y :close-on-content-click="false">
            <template v-slot:activator="{ on }">
              <v-btn block color="error darken-1" v-on="on">
                <v-icon left>mdi-delete</v-icon>
                Удалить все локальные данные
              </v-btn>
            </template>
            <v-card max-width="30vw">
              <v-card-text class="text-center stark--text">
                Это действие удалит все локальные данные COMP/CON. Облачные данные не будут затронуты.
                <v-divider class="my-3" />
                <v-btn
                  v-model="deleteLocalConfirm"
                  block
                  :color="deleteLocalConfirm ? 'secondary' : 'accent'"
                  @click="deleteLocalConfirm = true"
                >
                  Подтвердить
                </v-btn>
                <v-btn
                  block
                  small
                  color="error"
                  class="my-2"
                  :disabled="!deleteLocalConfirm"
                  @click="deleteAll(false)"
                >
                Удалить все локальные данные
                </v-btn>
              </v-card-text>
            </v-card>
          </v-menu>
        </v-col>
        <v-col v-if="username && username.length">
          <v-menu v-model="deleteCloud" top offset-y :close-on-content-click="false">
            <template v-slot:activator="{ on }">
              <v-btn block color="error darken-1" v-on="on">
                <v-icon left>mdi-cloud-alert</v-icon>
                Удалить все облачные данные
              </v-btn>
            </template>
            <v-card max-width="30vw">
              <v-card-text class="text-center stark--text">
                Это действие удалит все данные COMP/CON, хранящиеся в облаке под именем текущего пользователя ({{ username }}). Локальные данные не будут затронуты.
                <v-divider class="my-3" />
                <v-btn
                  v-model="deleteCloudConfirm"
                  block
                  :color="deleteCloudConfirm ? 'secondary' : 'accent'"
                  @click="deleteCloudConfirm = true"
                >
                  Подтвердить
                </v-btn>
                <v-btn
                  block
                  small
                  color="error"
                  class="my-2"
                  :disabled="!deleteCloudConfirm"
                  @click="deleteAll(true)"
                >
                Удалить все облачные данные
                </v-btn>
              </v-card-text>
            </v-card>
          </v-menu>
        </v-col>
      </v-row>
    </v-card-text>
  </v-card>
</template>

<script lang="ts">
import Vue from 'vue'
import { exportAll, importAll, clearAllData } from '@/io/BulkData'
import { saveFile } from '@/io/Dialog'

export default Vue.extend({
  name: 'backup-manager',
  props: {
    username: { type: String, required: true },
  },
  data: () => ({
    fileValue: null,
    loadBackupDialog: false,
    importConfirm: false,
    deleteLocal: false,
    deleteLocalConfirm: false,
    deleteCloud: false,
    deleteCloudConfirm: false,
  }),
  methods: {
    async dataExport() {
      const result = await exportAll()
      await saveFile(
        `CC_${new Date().toISOString().slice(0, 10)}.compcon`,
        JSON.stringify(result),
        'Сохранить архив COMP/CON'
      )
    },
    async importfile() {
      importAll(this.fileValue)
        .then(() => this.$notify('Импорт данных успешен', 'confirmation'))
        .catch(err => this.$notify(`ОШИБКА: Невозможно импортировать: ${err}`, 'error'))
        .finally(() => {
          this.fileValue = null
          this.loadBackupDialog = false
          this.importConfirm = false
          this.$emit('change')
        })
    },
    async deleteAll(cloud) {
      clearAllData(cloud)
        .then(() => this.$notify('Данные удалены', 'confirmation'))
        .catch(err => this.$notify(`ERROR: Невозможно импортировать: ${err}`, 'error'))
        .finally(() => {
          this.deleteCloud = false
          this.deleteCloudConfirm = false
          this.deleteLocal = false
          this.deleteLocalConfirm = false
          if (cloud) this.$emit('del-cloud')
          else this.$emit('del-local')
          this.$emit('change')
        })
    },
  },
})
</script>
